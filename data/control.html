<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>LED Control</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f4f4f9;
        color: #333;
        padding: 20px;
      }
      h1 {
        color: #0056b3;
      }
      .section {
        background: #fff;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
      }
      label {
        display: inline-block;
        width: 120px;
        font-weight: bold;
      }
      .slider-container,
      .dropdown-container,
      .button-container {
        margin: 10px 0;
        display: flex;
        align-items: center;
      }
      .slider-container input[type="range"] {
        margin: 0 10px;
        width: 200px;
      }
      .slider-container input[type="number"] {
        margin-left: 10px;
        width: 60px;
      }
      .dropdown-container select {
        margin-left: 10px;
      }
      button {
        padding: 8px 16px;
        margin-left: 10px;
        cursor: pointer;
      }
      nav a {
        margin-right: 15px;
        text-decoration: none;
        color: #0056b3;
        font-weight: bold;
      }
      #log {
        border: 1px solid #ccc;
        padding: 5px;
        height: 100px;
        overflow-y: auto;
        background: #fafafa;
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="/">Home</a>
      <a href="/status">Status</a>
      <a href="/update">Update Firmware</a>
      <a href="/updatefs">Update SPIFFS</a>
      <a href="/reboot">Reboot</a>
      <a href="/control">Control Panel</a>
    </nav>

    <h1>LED Control Panel</h1>

    <!-- Palettes -->
    <div class="section" id="paletteSection">
      <h2>Palettes</h2>
      <div>
        <label for="paletteSelect">Select Palette:</label>
        <select id="paletteSelect"></select>
        <button id="btnSetPalette">Set</button>
      </div>
      <!-- Removed the "Current Palette" text/label here -->
    </div>

    <!-- Brightness / Fade / Tail / Spawn / Max Flakes / Speed -->
    <div class="section">
      <h2>Flake Settings</h2>

      <!-- Brightness -->
      <div class="slider-container">
        <label for="sliderBrightness">Brightness:</label>
        <input
          type="range"
          id="sliderBrightness"
          min="0"
          max="255"
          value="30"
        />
        <input type="number" id="numBrightness" min="0" max="255" value="30" />
      </div>

      <!-- Fade Amount -->
      <div class="slider-container">
        <label for="sliderFade">Fade Amount:</label>
        <input type="range" id="sliderFade" min="0" max="255" value="80" />
        <input type="number" id="numFade" min="0" max="255" value="80" />
      </div>

      <!-- Tail Length -->
      <div class="slider-container">
        <label for="sliderTail">Tail Length:</label>
        <input type="range" id="sliderTail" min="1" max="30" value="5" />
        <input type="number" id="numTail" min="1" max="30" value="5" />
      </div>

      <!-- Spawn Rate -->
      <div class="slider-container">
        <label for="sliderSpawn">Spawn Rate:</label>
        <input
          type="range"
          id="sliderSpawn"
          step="0.01"
          min="0"
          max="1"
          value="0.6"
        />
        <input
          type="number"
          id="numSpawn"
          step="0.01"
          min="0"
          max="1"
          value="0.6"
        />
      </div>

      <!-- Max Flakes -->
      <div class="slider-container">
        <label for="sliderMaxFlakes">Max Flakes:</label>
        <input
          type="range"
          id="sliderMaxFlakes"
          min="10"
          max="500"
          value="200"
        />
        <input type="number" id="numMaxFlakes" min="10" max="500" value="200" />
      </div>

      <!-- Update Speed -->
      <div class="slider-container">
        <label for="sliderSpeed">Update Speed (ms):</label>
        <!-- A 'log-scale' slider from 0..100 -->
        <input
          type="range"
          id="sliderSpeed"
          min="0"
          max="100"
          step="1"
          value="10"
        />
        <!-- A numeric text box to type exact speed -->
        <input
          type="number"
          id="txtSpeed"
          min="10"
          max="60000"
          step="1"
          value="80"
        />
        <!-- Removed the separate <span id="lblSpeed"> -->
      </div>
    </div>

    <!-- Panel Settings -->
    <div class="section">
      <h2>Panel Settings</h2>
      <div class="button-container">
        <button id="btnSwapPanels">Swap Panels</button>
      </div>
      <div class="dropdown-container">
        <label>Panel Order:</label>
        <select id="selPanelOrder">
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
        <button id="btnSetPanelOrder">Set</button>
      </div>
      <div class="dropdown-container">
        <label>Rotate Panel1:</label>
        <select id="selRotateP1">
          <option value="0">0</option>
          <option value="90">90</option>
          <option value="180">180</option>
          <option value="270">270</option>
        </select>
        <button id="btnRotateP1">Rotate</button>
      </div>
      <div class="dropdown-container">
        <label>Rotate Panel2:</label>
        <select id="selRotateP2">
          <option value="0">0</option>
          <option value="90">90</option>
          <option value="180">180</option>
          <option value="270">270</option>
        </select>
        <button id="btnRotateP2">Rotate</button>
      </div>
    </div>

    <!-- Log / Output -->
    <div class="section">
      <h2>Log</h2>
      <div id="log"></div>
    </div>

    <script>
      /* ==============================
         Utility: Log to #log
      ============================== */
      const logDiv = document.getElementById("log");
      function log(msg) {
        console.log(msg);
        logDiv.innerText += msg + "\n";
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      // Palettes
      const paletteSelect = document.getElementById("paletteSelect");
      const btnSetPalette = document.getElementById("btnSetPalette");

      /* ==============================
         Sliders & Number Inputs
      ============================== */

      // Brightness
      const sBrightness = document.getElementById("sliderBrightness");
      const nBrightness = document.getElementById("numBrightness");

      // Fade
      const sFade = document.getElementById("sliderFade");
      const nFade = document.getElementById("numFade");

      // Tail
      const sTail = document.getElementById("sliderTail");
      const nTail = document.getElementById("numTail");

      // Spawn
      const sSpawn = document.getElementById("sliderSpawn");
      const nSpawn = document.getElementById("numSpawn");

      // MaxFlakes
      const sMaxFlakes = document.getElementById("sliderMaxFlakes");
      const nMaxFlakes = document.getElementById("numMaxFlakes");

      // Speed (special log-scale)
      const sSpeed = document.getElementById("sliderSpeed");
      const tSpeed = document.getElementById("txtSpeed");

      // Panel buttons
      const btnSwapPanels = document.getElementById("btnSwapPanels");
      const selPanelOrder = document.getElementById("selPanelOrder");
      const btnSetPanelOrder = document.getElementById("btnSetPanelOrder");
      const selRotateP1 = document.getElementById("selRotateP1");
      const btnRotateP1 = document.getElementById("btnRotateP1");
      const selRotateP2 = document.getElementById("selRotateP2");
      const btnRotateP2 = document.getElementById("btnRotateP2");

      /************************************************
       * 1) Basic Sliders (Brightness, Fade, etc.)
       *    We'll do a single "bindSliderAndNumber" function
       ************************************************/
      function bindSliderAndNumber(
        slider,
        numberInput,
        apiUrl,
        min,
        max,
        isFloat = false
      ) {
        // S1: slider -> number
        slider.addEventListener("input", () => {
          numberInput.value = slider.value;
        });

        // S2: slider -> server on "change"
        slider.addEventListener("change", () => {
          numberInput.value = slider.value; // ensure they're in sync
          sendToApi(apiUrl, slider.value);
        });

        // N1: number -> slider
        numberInput.addEventListener("input", () => {
          // clamp in JS
          let val = isFloat
            ? parseFloat(numberInput.value)
            : parseInt(numberInput.value, 10);
          if (isNaN(val)) val = min; // fallback
          if (val < min) val = min;
          if (val > max) val = max;
          numberInput.value = val;
          slider.value = val;
        });

        // N2: number -> server on "change"
        numberInput.addEventListener("change", () => {
          sendToApi(apiUrl, slider.value);
        });
      }

      function sendToApi(apiUrl, val) {
        fetch(`/api/${apiUrl}?val=${val}`)
          .then((r) => r.text())
          .then((txt) => log(txt))
          .catch((err) => log("Error: " + err));
      }

      // Bind each
      bindSliderAndNumber(sBrightness, nBrightness, "setBrightness", 0, 255);
      bindSliderAndNumber(sFade, nFade, "setFadeAmount", 0, 255);
      bindSliderAndNumber(sTail, nTail, "setTailLength", 1, 30);
      bindSliderAndNumber(sMaxFlakes, nMaxFlakes, "setMaxFlakes", 10, 500);
      // For spawn rate (float)
      bindSliderAndNumber(sSpawn, nSpawn, "setSpawnRate", 0.0, 1.0, true);

      /************************************************
       * 2) Special handling for "speed" with log-scale
       ************************************************/
      // We'll reuse the sliderToSpeed, speedToSliderVal from your previous logic
      function sliderToSpeed(sliderVal) {
        // sliderVal = 0..100
        const minSpeed = 10;
        const maxSpeed = 60000;
        const minLog = Math.log(minSpeed); // ~2.302585
        const maxLog = Math.log(maxSpeed); // ~11.0021
        const fraction = sliderVal / 100.0;
        const scale = minLog + (maxLog - minLog) * fraction;
        return Math.round(Math.exp(scale));
      }
      function speedToSliderVal(speed) {
        const minSpeed = 10;
        const maxSpeed = 60000;
        const minLog = Math.log(minSpeed);
        const maxLog = Math.log(maxSpeed);
        if (speed < minSpeed) speed = minSpeed;
        if (speed > maxSpeed) speed = maxSpeed;
        const scale = Math.log(speed);
        const fraction = (scale - minLog) / (maxLog - minLog);
        return Math.round(fraction * 100);
      }

      // Sync: slider <-> text input
      sSpeed.addEventListener("input", () => {
        const speedVal = sliderToSpeed(parseInt(sSpeed.value, 10));
        tSpeed.value = speedVal;
      });
      sSpeed.addEventListener("change", () => {
        // clamp, then send
        const speedVal = sliderToSpeed(parseInt(sSpeed.value, 10));
        tSpeed.value = speedVal;
        sendToApi("setSpeed", speedVal);
      });
      tSpeed.addEventListener("input", () => {
        // user typed a number
        let typedVal = parseInt(tSpeed.value, 10);
        if (isNaN(typedVal)) typedVal = 10;
        if (typedVal < 10) typedVal = 10;
        if (typedVal > 60000) typedVal = 60000;
        tSpeed.value = typedVal;
        // update slider
        sSpeed.value = speedToSliderVal(typedVal);
      });
      tSpeed.addEventListener("change", () => {
        let typedVal = parseInt(tSpeed.value, 10);
        if (isNaN(typedVal)) typedVal = 10;
        if (typedVal < 10) typedVal = 10;
        if (typedVal > 60000) typedVal = 60000;
        sendToApi("setSpeed", typedVal);
      });

      /************************************************
       * 3) Palette Handling
       ************************************************/
      function getPalette() {
        fetch("/api/getPalette")
          .then((r) => r.json())
          .then((obj) => {
            // set the dropdown to the current palette
            paletteSelect.value = obj.current;
          })
          .catch((err) => log("Palette fetch error: " + err));
      }

      btnSetPalette.addEventListener("click", () => {
        const pVal = paletteSelect.value; // 0-based palette index
        fetch(`/api/setPalette?val=${pVal}`)
          .then((r) => r.text())
          .then((txt) => {
            log(txt);
            getPalette(); // re-sync in case the code changed
          })
          .catch((err) => log("setPalette error: " + err));
      });

      /************************************************
       * 4) Panel Buttons
       ************************************************/
      btnSwapPanels.addEventListener("click", () => {
        fetch("/api/swapPanels")
          .then((r) => r.text())
          .then((txt) => log(txt))
          .catch((err) => log("swapPanels error: " + err));
      });

      btnSetPanelOrder.addEventListener("click", () => {
        const val = selPanelOrder.value; // "left" or "right"
        fetch(`/api/setPanelOrder?val=${val}`)
          .then((r) => r.text())
          .then((txt) => log(txt))
          .catch((err) => log("setPanelOrder error: " + err));
      });

      btnRotateP1.addEventListener("click", () => {
        const val = selRotateP1.value; // angle
        fetch(`/api/rotatePanel1?val=${val}`)
          .then((r) => r.text())
          .then((txt) => log(txt))
          .catch((err) => log("rotatePanel1 error: " + err));
      });

      btnRotateP2.addEventListener("click", () => {
        const val = selRotateP2.value;
        fetch(`/api/rotatePanel2?val=${val}`)
          .then((r) => r.text())
          .then((txt) => log(txt))
          .catch((err) => log("rotatePanel2 error: " + err));
      });

      /************************************************
       * 5) On page load
       ************************************************/
      window.addEventListener("load", () => {
        // Build palette dropdown
        fetch("/api/listPalettes")
          .then((res) => res.json())
          .then((data) => {
            paletteSelect.innerHTML = "";
            data.forEach((p, idx) => {
              const opt = document.createElement("option");
              opt.value = idx;
              opt.innerText = `${idx + 1}: ${p}`;
              paletteSelect.appendChild(opt);
            });
            // Then set current palette
            getPalette();
          })
          .catch((err) => log("Error fetching palette list: " + err));

        // Fetch brightness
        fetch("/api/getBrightness")
          .then((r) => r.text())
          .then((val) => {
            sBrightness.value = val;
            nBrightness.value = val;
          });

        // Fetch fade
        fetch("/api/getFadeAmount")
          .then((r) => r.text())
          .then((val) => {
            sFade.value = val;
            nFade.value = val;
          });

        // Fetch tail
        fetch("/api/getTailLength")
          .then((r) => r.text())
          .then((val) => {
            sTail.value = val;
            nTail.value = val;
          });

        // Fetch spawn
        fetch("/api/getSpawnRate")
          .then((r) => r.text())
          .then((val) => {
            sSpawn.value = val;
            nSpawn.value = val;
          });

        // Fetch max flakes
        fetch("/api/getMaxFlakes")
          .then((r) => r.text())
          .then((val) => {
            sMaxFlakes.value = val;
            nMaxFlakes.value = val;
          });

        // Fetch speed (log-scale)
        fetch("/api/getSpeed")
          .then((r) => r.text())
          .then((val) => {
            let spd = parseInt(val, 10);
            if (isNaN(spd)) spd = 80;
            tSpeed.value = spd;
            sSpeed.value = speedToSliderVal(spd);
          });
      });
    </script>
  </body>
</html>
