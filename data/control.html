<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>LED Control</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f4f4f9;
        color: #333;
        padding: 20px;
      }
      h1 {
        color: #0056b3;
      }
      .section {
        background: #fff;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
      }
      label {
        display: inline-block;
        width: 120px;
        font-weight: bold;
      }
      .slider-container,
      .dropdown-container,
      .button-container {
        margin: 10px 0;
        display: flex;
        align-items: center;
      }
      .slider-container input[type="range"] {
        margin: 0 10px;
        width: 200px;
      }
      .slider-container input[type="number"] {
        margin-left: 10px;
        width: 60px;
      }
      .dropdown-container select {
        margin-left: 10px;
      }
      button {
        padding: 8px 16px;
        margin-left: 10px;
        cursor: pointer;
      }
      nav a {
        margin-right: 15px;
        text-decoration: none;
        color: #0056b3;
        font-weight: bold;
      }
      #log {
        border: 1px solid #ccc;
        padding: 5px;
        height: 100px;
        overflow-y: auto;
        background: #fafafa;
      }
    </style>
  </head>

  <body>
    <nav>
      <a href="/">Home</a>
      <a href="/status">Status</a>
      <a href="/update">Update Firmware</a>
      <a href="/updatefs">Update SPIFFS</a>
      <a href="/reboot">Reboot</a>
      <a href="/control">Control Panel</a>
    </nav>

    <h1>LED Control Panel</h1>

    <!-- Animations -->
    <div class="section">
      <h2>Animations</h2>
      <div class="dropdown-container">
        <label for="selAnimation">Select Animation:</label>
        <!-- No extra button: we do it on 'change' event -->
        <select id="selAnimation"></select>
      </div>
    </div>

    <!-- Palettes -->
    <div class="section" id="paletteSection">
      <h2>Palettes</h2>
      <div>
        <label for="paletteSelect">Select Palette:</label>
        <select id="paletteSelect"></select>
        <button id="btnSetPalette">Set</button>
      </div>
    </div>

    <!-- Brightness / Fade / Tail / Spawn / Max Flakes / Speed -->
    <div class="section">
      <h2>Animation Settings</h2>

      <div class="slider-container">
        <label>Brightness:</label>
        <input
          type="range"
          id="sliderBrightness"
          min="0"
          max="255"
          value="30"
        />
        <input type="number" id="numBrightness" min="0" max="255" value="30" />
      </div>

      <div class="slider-container">
        <label>Fade:</label>
        <input type="range" id="sliderFade" min="0" max="255" value="80" />
        <input type="number" id="numFade" min="0" max="255" value="80" />
      </div>

      <div class="slider-container">
        <label>Length:</label>
        <input type="range" id="sliderTail" min="1" max="30" value="5" />
        <input type="number" id="numTail" min="1" max="30" value="5" />
      </div>

      <div class="slider-container">
        <label>Spawn Rate:</label>
        <input
          type="range"
          id="sliderSpawn"
          step="0.01"
          min="0"
          max="1"
          value="0.6"
        />
        <input
          type="number"
          id="numSpawn"
          step="0.01"
          min="0"
          max="1"
          value="0.6"
        />
      </div>

      <div class="slider-container">
        <label>Max Amount:</label>
        <input
          type="range"
          id="sliderMaxFlakes"
          min="10"
          max="500"
          value="200"
        />
        <input type="number" id="numMaxFlakes" min="10" max="500" value="200" />
      </div>

      <div class="slider-container">
        <label>Speed (ms):</label>
        <input
          type="range"
          id="sliderSpeed"
          min="0"
          max="100"
          step="1"
          value="10"
        />
        <input
          type="number"
          id="txtSpeed"
          min="10"
          max="60000"
          step="1"
          value="80"
        />
      </div>
    </div>

    <!-- Panel Settings -->
    <div class="section">
      <h2>Panel Settings</h2>
      <div class="button-container">
        <button id="btnSwapPanels">Swap Panels</button>
      </div>
      <div class="dropdown-container">
        <label>Panel Order:</label>
        <select id="selPanelOrder">
          <option value="left">Left</option>
          <option value="right">Right</option>
        </select>
        <button id="btnSetPanelOrder">Set</button>
      </div>
      <div class="dropdown-container">
        <label>Rotate Panel1:</label>
        <select id="selRotateP1">
          <option value="0">0</option>
          <option value="90">90</option>
          <option value="180">180</option>
          <option value="270">270</option>
        </select>
        <button id="btnRotateP1">Rotate</button>
      </div>
      <div class="dropdown-container">
        <label>Rotate Panel2:</label>
        <select id="selRotateP2">
          <option value="0">0</option>
          <option value="90">90</option>
          <option value="180">180</option>
          <option value="270">270</option>
        </select>
        <button id="btnRotateP2">Rotate</button>
      </div>
    </div>

    <!-- Log / Output -->
    <div class="section">
      <h2>Log</h2>
      <div id="log"></div>
    </div>

    <script>
      /* ========== Logging ========== */
      const logDiv = document.getElementById("log");
      function log(msg) {
        console.log(msg);
        logDiv.innerText += msg + "\n";
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      /* ========== ANIMATION DROPDOWN ========== */
      const selAnimation = document.getElementById("selAnimation");

      // 1) We do the immediate switch as soon as user picks from the dropdown:
      selAnimation.addEventListener("change", () => {
        const val = selAnimation.value;
        fetch(`/api/setAnimation?val=${val}`)
          .then((r) => r.text())
          .then((txt) => log(txt))
          .catch((err) => log("setAnimation error: " + err));
      });

      // 2) Function that loads the list of animations from the server
      function loadAnimationList() {
        fetch("/api/listAnimations")
          .then((r) => r.json())
          .then((data) => {
            selAnimation.innerHTML = "";
            data.forEach((animName, idx) => {
              const opt = document.createElement("option");
              opt.value = idx;
              opt.innerText = `${idx}: ${animName}`;
              selAnimation.appendChild(opt);
            });
            // Optionally fetch current anim from /api/getAnimation if needed
          })
          .catch((err) => log("Error fetching animations: " + err));
      }

      /* ========== PALETTES ========== */
      const paletteSelect = document.getElementById("paletteSelect");
      const btnSetPalette = document.getElementById("btnSetPalette");

      function getPalette() {
        fetch("/api/getPalette")
          .then((r) => r.json())
          .then((obj) => {
            // 'obj.current' is 0-based index
            paletteSelect.value = obj.current;
          })
          .catch((err) => log("Palette fetch error: " + err));
      }

      btnSetPalette.addEventListener("click", () => {
        const pVal = paletteSelect.value;
        fetch(`/api/setPalette?val=${pVal}`)
          .then((r) => r.text())
          .then((txt) => {
            log(txt);
            // Possibly call getPalette() again if you want to confirm
          })
          .catch((err) => log("setPalette error: " + err));
      });

      /* ========== SLIDERS + NUMBER BOXES ========== */
      const sBrightness = document.getElementById("sliderBrightness");
      const nBrightness = document.getElementById("numBrightness");
      const sFade = document.getElementById("sliderFade");
      const nFade = document.getElementById("numFade");
      const sTail = document.getElementById("sliderTail");
      const nTail = document.getElementById("numTail");
      const sSpawn = document.getElementById("sliderSpawn");
      const nSpawn = document.getElementById("numSpawn");
      const sMaxFlakes = document.getElementById("sliderMaxFlakes");
      const nMaxFlakes = document.getElementById("numMaxFlakes");
      const sSpeed = document.getElementById("sliderSpeed");
      const tSpeed = document.getElementById("txtSpeed");

      // Helper to bind a slider & number input to an API call
      function bindSliderAndNumber(
        slider,
        numberInput,
        apiUrl,
        min,
        max,
        isFloat = false
      ) {
        slider.addEventListener("input", () => {
          numberInput.value = slider.value;
        });
        slider.addEventListener("change", () => {
          numberInput.value = slider.value;
          sendToApi(apiUrl, slider.value);
        });
        numberInput.addEventListener("input", () => {
          let val = isFloat
            ? parseFloat(numberInput.value)
            : parseInt(numberInput.value, 10);
          if (isNaN(val)) val = min;
          if (val < min) val = min;
          if (val > max) val = max;
          numberInput.value = val;
          slider.value = val;
        });
        numberInput.addEventListener("change", () => {
          sendToApi(apiUrl, slider.value);
        });
      }

      function sendToApi(apiUrl, val) {
        fetch(`/api/${apiUrl}?val=${val}`)
          .then((r) => r.text())
          .then((txt) => log(txt))
          .catch((err) => log("Error: " + err));
      }

      bindSliderAndNumber(sBrightness, nBrightness, "setBrightness", 0, 255);
      bindSliderAndNumber(sFade, nFade, "setFadeAmount", 0, 255);
      bindSliderAndNumber(sTail, nTail, "setTailLength", 1, 30);
      bindSliderAndNumber(sMaxFlakes, nMaxFlakes, "setMaxFlakes", 10, 500);
      bindSliderAndNumber(sSpawn, nSpawn, "setSpawnRate", 0, 1, true);

      // Speed (log-scale):
      function sliderToSpeed(slVal) {
        const minSpeed = 10,
          maxSpeed = 60000;
        const minLog = Math.log(minSpeed),
          maxLog = Math.log(maxSpeed);
        const fraction = slVal / 100.0;
        const scale = minLog + (maxLog - minLog) * fraction;
        return Math.round(Math.exp(scale));
      }
      function speedToSliderVal(spd) {
        const minSpeed = 10,
          maxSpeed = 60000;
        const minLog = Math.log(minSpeed),
          maxLog = Math.log(maxSpeed);
        if (spd < minSpeed) spd = minSpeed;
        if (spd > maxSpeed) spd = maxSpeed;
        const scale = Math.log(spd);
        const fraction = (scale - minLog) / (maxLog - minLog);
        return Math.round(fraction * 100);
      }

      sSpeed.addEventListener("input", () => {
        tSpeed.value = sliderToSpeed(parseInt(sSpeed.value, 10));
      });
      sSpeed.addEventListener("change", () => {
        const val = sliderToSpeed(parseInt(sSpeed.value, 10));
        tSpeed.value = val;
        sendToApi("setSpeed", val);
      });
      tSpeed.addEventListener("input", () => {
        let typedVal = parseInt(tSpeed.value, 10);
        if (isNaN(typedVal)) typedVal = 10;
        if (typedVal < 10) typedVal = 10;
        if (typedVal > 60000) typedVal = 60000;
        sSpeed.value = speedToSliderVal(typedVal);
      });
      tSpeed.addEventListener("change", () => {
        let typedVal = parseInt(tSpeed.value, 10);
        if (isNaN(typedVal)) typedVal = 10;
        if (typedVal < 10) typedVal = 10;
        if (typedVal > 60000) typedVal = 60000;
        sendToApi("setSpeed", typedVal);
      });

      /* ========== PANEL BUTTONS ========== */
      const btnSwapPanels = document.getElementById("btnSwapPanels");
      const selPanelOrder = document.getElementById("selPanelOrder");
      const btnSetPanelOrder = document.getElementById("btnSetPanelOrder");
      const selRotateP1 = document.getElementById("selRotateP1");
      const btnRotateP1 = document.getElementById("btnRotateP1");
      const selRotateP2 = document.getElementById("selRotateP2");
      const btnRotateP2 = document.getElementById("btnRotateP2");

      btnSwapPanels.addEventListener("click", () => {
        fetch("/api/swapPanels")
          .then((r) => r.text())
          .then((txt) => log(txt))
          .catch((err) => log("swapPanels error: " + err));
      });
      btnSetPanelOrder.addEventListener("click", () => {
        const val = selPanelOrder.value;
        fetch(`/api/setPanelOrder?val=${val}`)
          .then((r) => r.text())
          .then((txt) => log(txt))
          .catch((err) => log("setPanelOrder error: " + err));
      });
      btnRotateP1.addEventListener("click", () => {
        const val = selRotateP1.value;
        fetch(`/api/rotatePanel1?val=${val}`)
          .then((r) => r.text())
          .then((txt) => log(txt))
          .catch((err) => log("rotatePanel1 error: " + err));
      });
      btnRotateP2.addEventListener("click", () => {
        const val = selRotateP2.value;
        fetch(`/api/rotatePanel2?val=${val}`)
          .then((r) => r.text())
          .then((txt) => log(txt))
          .catch((err) => log("rotatePanel2 error: " + err));
      });

      /* ========== ON PAGE LOAD ========== */
      window.addEventListener("load", () => {
        // 1) Load animation list
        loadAnimationList();

        // 2) Load palette list
        fetch("/api/listPalettes")
          .then((res) => res.json())
          .then((data) => {
            paletteSelect.innerHTML = "";
            data.forEach((p, idx) => {
              const opt = document.createElement("option");
              opt.value = idx;
              opt.innerText = `${idx + 1}: ${p}`;
              paletteSelect.appendChild(opt);
            });
            getPalette(); // fetch the current palette index from server
          })
          .catch((err) => log("Error fetching palette list: " + err));

        // 3) Load current brightness
        fetch("/api/getBrightness")
          .then((r) => r.text())
          .then((val) => {
            sBrightness.value = val;
            nBrightness.value = val;
          });

        // 4) fade
        fetch("/api/getFadeAmount")
          .then((r) => r.text())
          .then((val) => {
            sFade.value = val;
            nFade.value = val;
          });

        // 5) tail
        fetch("/api/getTailLength")
          .then((r) => r.text())
          .then((val) => {
            sTail.value = val;
            nTail.value = val;
          });

        // 6) spawn
        fetch("/api/getSpawnRate")
          .then((r) => r.text())
          .then((val) => {
            sSpawn.value = val;
            nSpawn.value = val;
          });

        // 7) max flakes
        fetch("/api/getMaxFlakes")
          .then((r) => r.text())
          .then((val) => {
            sMaxFlakes.value = val;
            nMaxFlakes.value = val;
          });

        // 8) speed
        fetch("/api/getSpeed")
          .then((r) => r.text())
          .then((val) => {
            let spd = parseInt(val, 10);
            if (isNaN(spd)) spd = 80;
            tSpeed.value = spd;
            sSpeed.value = speedToSliderVal(spd);
          });
      });
    </script>
  </body>
</html>
